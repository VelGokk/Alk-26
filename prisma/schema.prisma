generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPERADMIN
  ADMIN
  INSTRUCTOR
  REVIEWER
  MODERATOR
  USER
  SUBSCRIBER
}

enum CourseStatus {
  DRAFT
  IN_REVIEW
  PUBLISHED
  REJECTED
  ARCHIVED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ContentReviewState {
  PENDING
  IN_REVIEW
  CHANGES_REQUESTED
  APPROVED
  PUBLISHED
}

enum ResourceType {
  PDF
  IMAGE
  VIDEO
  OTHER
}

  enum LessonContentType {
    VIDEO
    TEXT
    QUIZ
    LIVE
  }

  enum LessonVideoProvider {
    YOUTUBE
    VIMEO
    LOOM
    OTHER
  }

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELED
}

enum PaymentStatus {
  PENDING
  APPROVED
  FAILED
  REFUNDED
  PROCESSING
  CANCELLED
}

  enum PaymentProvider {
    MERCADOPAGO
    MANUAL
    STRIPE
  }

enum CouponType {
  PERCENT
  FIXED
}

enum LogLevel {
  INFO
  WARN
  ERROR
}

enum LearningProfileId {
  BALANCED
  DISCOVERER
  PRACTITIONER
  SUSTAINER
}

enum LearningPathId {
  FOUNDATION
  ACTION
  SUSTAINMENT
  EXPEDITION
}

enum ModerationTargetType {
  USER
  COMMENT
  RESOURCE
  LESSON
}

enum ModerationStatus {
  OPEN
  IN_REVIEW
  RESOLVED
}

enum ModerationActionType {
  HIDE
  WARN
  RESOLVE
  DELETE
  BAN
}

enum CommentTargetType {
  COURSE
  LESSON
  RESOURCE
}

enum NotificationType {
  REVIEW_REQUESTED
  REVIEW_APPROVED
  REVIEW_CHANGES_REQUESTED
  CERTIFICATE_READY
  EVENT
}

enum ShareLevel {
  PRIVATE
  TEAM
  PUBLIC
}

enum InsightStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id                 String            @id @default(cuid())
  name               String?
  email              String            @unique
  emailVerified      DateTime?
  image              String?
  passwordHash       String?
  role               Role              @default(USER)
  isActive           Boolean           @default(true)
  locale             String            @default("es-ar")
  learningProfile    LearningProfileId @default(BALANCED)
  learningPath       LearningPathId?
  organizationId     String?
  organization       Organization?     @relation(fields: [organizationId], references: [id])
  lastLoginAt        DateTime?
  pendingLegalUpdate Boolean           @default(false)
  suspendedUntil     DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  accounts                 Account[]
  sessions                 Session[]
  courses                  Course[]                 @relation("InstructorCourses")
  reviews                  CourseReview[]           @relation("ReviewerCourses")
  enrollments              Enrollment[]
  certificates             Certificate[]
  payments                 Payment[]
  cart                     Cart?
  comments                 Comment[]
  reports                  ModerationReport[]       @relation("ReporterReports")
  moderationActions        ModerationAction[]       @relation("ModeratorActions")
  subjectModerationActions ModerationAction[]       @relation("SubjectActions")
  logs                     SystemLog[]
  auditLogs                AuditLog[]
  blogPosts                BlogPost[]
  couponsCreated           Coupon[]                 @relation("CouponCreator")
  liveSessions             LiveSession[]            @relation("LiveSessionCreator")
  uploadedResources        CourseResource[]         @relation("UploadedResources")
  userRoles                UserRole[]
  instructorContentReviews ContentReview[]          @relation("InstructorContentReviews")
  reviewerContentReviews   ContentReview[]          @relation("ReviewerContentReviews")
  reviewFeedbacks          ReviewFeedback[]         @relation("UserFeedbacks")
  reviewDecisions          ReviewDecision[]         @relation("UserDecisions")
  signatures               LegalSignature[]
  signedLegalDocumentId    String?
  signedLegalDocument      LegalDocument?           @relation("SignedDocument", fields: [signedLegalDocumentId], references: [id])
  programEnrollments       ProgramEnrollment[]
  ontologicalLogs          OntologicalLog[]
  insightPosts             InsightPost[]
  notifications            Notification[]
  notificationPreferences  NotificationPreference[]
  referralPoints           Int                      @default(0)
  usedReferralCodeId       String?
  usedReferralCode         ReferralCode?            @relation("UsedReferralCode", fields: [usedReferralCodeId], references: [id])
  referralCodes            ReferralCode[]           @relation("CreatedCodes")
  referralUsages           ReferralUsage[]          @relation("ReferredUsages")
  learningPathAssignments  LearningPathAssignment[]
  onboardingSession        OnboardingSession?
  eventReminders           EventReminder[]

  @@index([role])
  @@index([isActive])
  @@index([learningPath])
  @@index([organizationId])
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  locale    String   @default("es-ar")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  tenantConfig TenantConfig?
  insightPosts InsightPost[]
}

model TenantConfig {
  id                  String   @id @default(cuid())
  organizationId      String   @unique
  slug                String   @unique
  tenantName          String
  logoUrl             String?
  primaryColor        String?
  secondaryColor      String?
  accentColor         String?
  cursorColor         String?
  ctaGlowColor        String?
  panelRadiusSpecific Int?
  panelBlurSpecific   Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Course {
  id           String       @id @default(cuid())
  title        String
  slug         String       @unique
  description  String
  price        Int          @default(0)
  currency     String       @default("ARS")
  thumbnailUrl String?
  status       CourseStatus @default(DRAFT)
  instructorId String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  instructor  User             @relation("InstructorCourses", fields: [instructorId], references: [id])
  modules     CourseModule[]
  resources   CourseResource[]
  enrollments Enrollment[]
  cartItems   CartItem[]
  reviews     CourseReview[]
  comments    Comment[]

  @@index([status])
  @@index([instructorId])
}

model CourseModule {
  id        String   @id @default(cuid())
  title     String
  order     Int      @default(0)
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@index([courseId])
}

  model Lesson {
    id          String            @id @default(cuid())
    title       String
    content     String?
    contentType LessonContentType @default(TEXT)
    videoUrl        String?
    videoProvider   LessonVideoProvider?
    loomUrl         String?
    durationSeconds Int?
    order       Int               @default(0)
    durationMin Int?
    moduleId    String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  module         CourseModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress       LessonProgress[]
  contentReviews ContentReview[]

  @@index([moduleId])
}

model ContentReview {
  id           String             @id @default(cuid())
  lessonId     String
  instructorId String
  reviewerId   String?
  status       ContentReviewState @default(PENDING)
  summary      String?
  checklist    Json?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @default(now()) @updatedAt

  lesson     Lesson           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  instructor User             @relation("InstructorContentReviews", fields: [instructorId], references: [id], onDelete: Cascade)
  reviewer   User?            @relation("ReviewerContentReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
  feedback   ReviewFeedback[]
  decisions  ReviewDecision[]

  @@unique([lessonId, instructorId])
  @@index([lessonId])
  @@index([status])
}

model ReviewFeedback {
  id        String   @id @default(cuid())
  reviewId  String
  authorId  String
  anchor    String?
  message   String
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())

  review ContentReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  author User          @relation("UserFeedbacks", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([authorId])
}

model ReviewDecision {
  id          String             @id @default(cuid())
  reviewId    String
  createdById String
  state       ContentReviewState
  checklist   Json
  notes       String?
  createdAt   DateTime           @default(now())

  review    ContentReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  createdBy User          @relation("UserDecisions", fields: [createdById], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([createdById])
}

model CourseResource {
  id           String       @id @default(cuid())
  title        String
  type         ResourceType @default(OTHER)
  url          String
  courseId     String
  uploadedById String?
  createdAt    DateTime     @default(now())

  course     Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  uploadedBy User?  @relation("UploadedResources", fields: [uploadedById], references: [id])

  @@index([courseId])
}

enum ProgramPhase {
  DISCOVERY
  PRACTICE
  SUSTAINMENT
}

model Program {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String
  summary   String?
  strapline String?
  duration  String?
  intensity String?
  heroImage String?
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  modules         ProgramModule[]
  enrollments     ProgramEnrollment[]
  certificates    Certificate[]
  tagRelations    ProgramTagRelation[]
  ontologicalLogs OntologicalLog[]

  events Event[]
}

model ProgramModule {
  id        String       @id @default(cuid())
  programId String
  title     String
  summary   String?
  phase     ProgramPhase @default(DISCOVERY)
  order     Int          @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  program Program         @relation(fields: [programId], references: [id], onDelete: Cascade)
  lessons ProgramLesson[]

  @@index([programId, order])
}

  model ProgramLesson {
    id          String   @id @default(cuid())
    moduleId    String
    title       String
    summary     String?
    content         String?
    videoUrl        String?
    videoProvider   LessonVideoProvider?
    loomUrl         String?
    durationMin     Int?
    durationSeconds Int?
    order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  module    ProgramModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  resources ProgramResource[]
  progress  ProgramProgress[]
  comments  Comment[]

  @@index([moduleId, order])
}

model ProgramResource {
  id        String   @id @default(cuid())
  lessonId  String
  title     String
  url       String
  type      String   @default("link")
  createdAt DateTime @default(now())

  lesson   ProgramLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  comments Comment[]

  @@index([lessonId])
}

model Event {
  id          String   @id @default(cuid())
  programId   String
  title       String
  description String?
  scheduledAt DateTime
  link        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  program   Program         @relation(fields: [programId], references: [id], onDelete: Cascade)
  reminders EventReminder[]

  @@index([scheduledAt])
  @@index([programId])
}

model EventReminder {
  id      String   @id @default(cuid())
  eventId String
  userId  String
  sentAt  DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([sentAt])
}

model ProgramEnrollment {
  id              String   @id @default(cuid())
  userId          String
  programId       String
  status          String   @default("ACTIVE")
  progressPercent Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  program  Program           @relation(fields: [programId], references: [id], onDelete: Cascade)
  progress ProgramProgress[]

  @@unique([userId, programId])
  @@index([programId])
}

model ProgramProgress {
  id           String       @id @default(cuid())
  enrollmentId String
  lessonId     String
  phase        ProgramPhase
  completed    Boolean      @default(false)
  completedAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @default(now()) @updatedAt

  enrollment ProgramEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     ProgramLesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@index([lessonId])
}

model ProgramTag {
  id        String               @id @default(cuid())
  name      String
  slug      String               @unique
  relations ProgramTagRelation[]
}

model ProgramTagRelation {
  id        String @id @default(cuid())
  programId String
  tagId     String

  program Program    @relation(fields: [programId], references: [id], onDelete: Cascade)
  tag     ProgramTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([programId, tagId])
  @@index([tagId])
}

model OntologicalLog {
  id         String     @id @default(cuid())
  userId     String
  programId  String
  content    String
  isPrivate  Boolean    @default(false)
  shareLevel ShareLevel @default(PRIVATE)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  program      Program       @relation(fields: [programId], references: [id], onDelete: Cascade)
  insightPosts InsightPost[]

  @@unique([userId, programId])
  @@index([programId])
}

model InsightPost {
  id               String        @id @default(cuid())
  organizationId   String
  ontologicalLogId String?
  createdById      String?
  content          String
  isAnonymous      Boolean       @default(true)
  shareLevel       ShareLevel    @default(PRIVATE)
  status           InsightStatus @default(PENDING)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ontologicalLog OntologicalLog? @relation(fields: [ontologicalLogId], references: [id])
  author         User?           @relation(fields: [createdById], references: [id])

  @@index([organizationId])
  @@index([status])
}

model CourseReview {
  id         String       @id @default(cuid())
  courseId   String
  reviewerId String
  status     ReviewStatus @default(PENDING)
  comment    String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  reviewer User   @relation("ReviewerCourses", fields: [reviewerId], references: [id])

  @@index([status])
}

model Enrollment {
  id              String           @id @default(cuid())
  userId          String
  courseId        String
  status          EnrollmentStatus @default(ACTIVE)
  progressPercent Int              @default(0)
  purchasedAt     DateTime         @default(now())
  completedAt     DateTime?
  paymentId       String?

  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  payment     Payment?         @relation(fields: [paymentId], references: [id])
  progress    LessonProgress[]
  certificate Certificate?

  @@unique([userId, courseId])
}

model LessonProgress {
  id           String    @id @default(cuid())
  enrollmentId String
  lessonId     String
  completed    Boolean   @default(false)
  completedAt  DateTime?

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
}

model Cart {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]
}

model CartItem {
  id       String   @id @default(cuid())
  cartId   String
  courseId String
  quantity Int      @default(1)
  addedAt  DateTime @default(now())

  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([cartId, courseId])
}

model Payment {
  id                String          @id @default(cuid())
  userId            String
  provider          PaymentProvider @default(MERCADOPAGO)
  providerPaymentId String?
  status            PaymentStatus   @default(PENDING)
  amount            Int
  currency          String          @default("ARS")
  metadata          Json?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments   Enrollment[]
  webhookEvents PaymentWebhookEvent[]

  @@index([status])
}

model PaymentWebhookEvent {
  id              String        @id @default(cuid())
  paymentId       String
  providerEventId String
  idempotencyKey  String?
  status          PaymentStatus
  payload         Json
  createdAt       DateTime      @default(now())

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@unique([providerEventId])
  @@unique([idempotencyKey])
  @@index([paymentId])
}

model Certificate {
  id                String   @id @default(cuid())
  enrollmentId      String   @unique
  userId            String
  programId         String
  certificateNumber String
  issuedAt          DateTime @default(now())
  metadata          Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  program    Program    @relation(fields: [programId], references: [id], onDelete: Cascade)
}

model EmailRetry {
  id            String    @id @default(cuid())
  to            String
  subject       String
  html          String
  attempts      Int       @default(0)
  lastError     String?
  nextAttemptAt DateTime?
  metadata      Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Coupon {
  id             String     @id @default(cuid())
  code           String     @unique
  type           CouponType @default(PERCENT)
  amount         Int
  active         Boolean    @default(true)
  maxRedemptions Int?
  redemptions    Int        @default(0)
  expiresAt      DateTime?
  createdById    String?
  createdAt      DateTime   @default(now())

  createdBy User? @relation("CouponCreator", fields: [createdById], references: [id])
}

model BlogPost {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  excerpt     String?
  content     String
  published   Boolean   @default(false)
  publishedAt DateTime?
  authorId    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  author User? @relation(fields: [authorId], references: [id])
}

model PublicResource {
  id          String   @id @default(cuid())
  title       String
  description String?
  url         String
  createdAt   DateTime @default(now())
}

model Comment {
  id         String            @id @default(cuid())
  content    String
  userId     String
  targetType CommentTargetType @default(COURSE)
  courseId   String?
  lessonId   String?
  resourceId String?
  isHidden   Boolean           @default(false)
  isDeleted  Boolean           @default(false)
  clientIp   String?
  userAgent  String?
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  course   Course?            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson   ProgramLesson?     @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  resource ProgramResource?   @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  reports  ModerationReport[] @relation("CommentReports")

  @@index([courseId])
  @@index([lessonId])
  @@index([resourceId])
}

model ModerationReport {
  id         String               @id @default(cuid())
  targetType ModerationTargetType
  targetId   String
  reason     String
  status     ModerationStatus     @default(OPEN)
  reporterId String?
  commentId  String?
  reportedAt DateTime             @default(now())
  resolvedAt DateTime?
  details    Json?
  createdAt  DateTime             @default(now())

  reporter User?              @relation("ReporterReports", fields: [reporterId], references: [id])
  actions  ModerationAction[]
  comment  Comment?           @relation("CommentReports", fields: [commentId], references: [id], onDelete: Cascade)

  @@index([targetType, targetId])
  @@index([commentId])
}

model ModerationAction {
  id            String               @id @default(cuid())
  reportId      String
  actionType    ModerationActionType
  note          String?
  moderatorId   String?
  subjectUserId String?
  expiresAt     DateTime?
  details       Json?
  createdAt     DateTime             @default(now())

  report    ModerationReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  moderator User?            @relation("ModeratorActions", fields: [moderatorId], references: [id])
  subject   User?            @relation("SubjectActions", fields: [subjectUserId], references: [id])

  @@index([reportId])
  @@index([subjectUserId])
}

model SystemLog {
  id        String   @id @default(cuid())
  level     LogLevel @default(INFO)
  action    String
  message   String
  meta      Json?
  userId    String?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}

model AuditLog {
  id           String   @id @default(cuid())
  action       String
  resourceType String?
  resourceId   String?
  userId       String?
  status       String?
  source       String?
  ip           String?
  userAgent    String?
  metadata     Json?
  createdAt    DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resourceType, resourceId])
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  body        String
  referenceId String?
  metadata    Json?
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, type])
}

model NotificationPreference {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  enabled   Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
}

model IntegrationSetting {
  id         String   @id @default(cuid())
  provider   String   @unique
  isEnabled  Boolean  @default(false)
  publicKey  String?
  webhookUrl String?
  notes      String?
  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())
}

model BrandingSetting {
  id             String   @id @default(cuid())
  logoUrl        String?
  primaryColor   String   @default("#0B0D0E")
  secondaryColor String   @default("#F5F1E8")
  accentColor    String   @default("#8C6C3F")
  panelRadius    Int      @default(24)
  panelBlur      Int      @default(16)
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())
}

model SystemSetting {
  id                 String   @id @default(cuid())
  maintenanceMode    Boolean  @default(false)
  maintenanceMessage String   @default("Estamos realizando mejoras. Volve en unos minutos.")
  updatedAt          DateTime @updatedAt
  createdAt          DateTime @default(now())
}

model Page {
  id          String   @id @default(cuid())
  slug        String
  lang        String
  seoTitle    String?
  seoDesc     String?
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sections Section[]

  @@unique([slug, lang])
  @@index([slug])
  @@index([lang])
}

model Section {
  id        String   @id @default(cuid())
  pageId    String
  type      String
  order     Int      @default(0)
  enabled   Boolean  @default(true)
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([pageId, order])
}

model PageDraft {
  id           String   @id @default(cuid())
  slug         String
  lang         String
  seoTitle     String?
  seoDesc      String?
  previewToken String   @unique @default(cuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  sections DraftSection[]

  @@unique([slug, lang])
  @@index([slug, lang])
}

model DraftSection {
  id          String   @id @default(cuid())
  pageDraftId String
  type        String
  order       Int      @default(0)
  enabled     Boolean  @default(true)
  data        Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  pageDraft PageDraft @relation(fields: [pageDraftId], references: [id], onDelete: Cascade)

  @@index([pageDraftId, order])
}

model LiveSession {
  id              String    @id @default(cuid())
  title           String
  status          String    @default("scheduled")
  muxLiveStreamId String?
  muxStreamKey    String?
  muxPlaybackId   String?
  scheduledAt     DateTime?
  createdById     String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  createdBy User? @relation("LiveSessionCreator", fields: [createdById], references: [id])
}

model ReferralCode {
  id           String   @id @default(cuid())
  code         String   @unique
  label        String?
  description  String?
  rewardPoints Int      @default(100)
  isActive     Boolean  @default(true)
  createdById  String?
  createdAt    DateTime @default(now())

  creator     User?           @relation("CreatedCodes", fields: [createdById], references: [id])
  usages      ReferralUsage[]
  usedByUsers User[]          @relation("UsedReferralCode")

  @@index([createdById])
}

model ReferralUsage {
  id                  String   @id @default(cuid())
  referralCodeId      String
  referredUserId      String?
  referredEmail       String
  refererRewardPoints Int
  refereeRewardPoints Int
  rewardedReferer     Boolean  @default(false)
  rewardedReferee     Boolean  @default(false)
  createdAt           DateTime @default(now())

  referralCode ReferralCode @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)
  referredUser User?        @relation("ReferredUsages", fields: [referredUserId], references: [id])

  @@index([referralCodeId])
  @@index([referredUserId])
}

model LegalDocument {
  id            String   @id @default(cuid())
  roleTarget    Role
  title         String
  content       String
  versionNumber Int
  isActive      Boolean  @default(false)
  createdAt     DateTime @default(now())

  signatures  LegalSignature[]
  signedUsers User[]           @relation("SignedDocument")

  @@index([roleTarget])
}

model LegalSignature {
  id              String   @id @default(cuid())
  userId          String
  legalDocumentId String
  versionNumber   Int
  signedAt        DateTime @default(now())
  ip              String?
  userAgent       String?

  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  legalDocument LegalDocument @relation(fields: [legalDocumentId], references: [id], onDelete: Cascade)

  @@unique([userId, legalDocumentId, versionNumber])
  @@index([legalDocumentId])
  @@index([userId])
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  role      Role
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([role])
}

model RolePermission {
  id         String   @id @default(cuid())
  role       Role
  permission String
  createdAt  DateTime @default(now())

  @@unique([role, permission])
  @@index([role])
}

model LearningPathAssignment {
  id        String         @id @default(cuid())
  userId    String
  path      LearningPathId
  isActive  Boolean        @default(true)
  createdAt DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model OnboardingSession {
  userId          String             @id
  step            Int                @default(1)
  answers         Json               @default("{}")
  learningProfile LearningProfileId?
  learningPath    LearningPathId?
  isComplete      Boolean            @default(false)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([learningProfile])
  @@index([learningPath])
}
